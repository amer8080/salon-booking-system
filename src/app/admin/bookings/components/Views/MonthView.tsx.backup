'use client'

import { useCallback } from 'react'
import { Booking, BlockedTime } from '../../types/booking.types'
import { formatIstanbulDate, getDaysInMonth } from '@/lib/timezone'

interface MonthViewProps {
  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®
  currentMonth: Date

  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
  bookings: Booking[]
  blockedTimes: BlockedTime[]

  // Ø§Ù„ØªÙØ§Ø¹Ù„
  onSwitchToDayView: (date: string) => void

  className?: string
}

export default function MonthView({
  currentMonth,
  bookings,
  blockedTimes,
  onSwitchToDayView,
  className = ""
}: MonthViewProps) {

  // Ø­Ø³Ø§Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„Ø´Ù‡Ø±
  const daysData = getDaysInMonth(currentMonth)
  const today = new Date()
  const todayString = formatIstanbulDate(today, 'date')

  // Ø£Ø³Ù…Ø§Ø¡ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù…Ø®ØªØµØ±Ø©
  const dayNames = ['Ø­', 'Ù†', 'Ø«', 'Ø±', 'Ø®', 'Ø¬', 'Ø³']

  // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙŠÙˆÙ… Ù…Ù‚ÙÙ„
  const isDayBlocked = useCallback((dateString: string) => {
    return blockedTimes.some(blocked =>
      blocked.startTime === null && 
      blocked.endTime === null &&
      blocked.date === dateString
    )
  }, [blockedTimes])

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…
  const getBookingsForDate = useCallback((dateString: string) => {
    return bookings.filter(booking => {
      const bookingDate = formatIstanbulDate(new Date(booking.date), 'date')
      return bookingDate === dateString
    })
  }, [bookings])

  // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙŠÙˆÙ… Ù…Ø­Ø¬ÙˆØ²
  const isDayBooked = useCallback((dateString: string) => {
    const dayBookings = getBookingsForDate(dateString)
    return dayBookings.length > 0
  }, [getBookingsForDate])

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ…
  const handleDayClick = useCallback((dayData: {date: string, day: number, isCurrentMonth: boolean}) => {
    if (!dayData.isCurrentMonth) return

    // Ø§Ù„ØªØ­ÙˆÙ„ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ…ÙŠ
    onSwitchToDayView(dayData.date)
  }, [onSwitchToDayView])

  return (
    <div className={`bg-white rounded-xl shadow-lg p-6 ${className}`}>

      {/* Ø£Ø³Ù…Ø§Ø¡ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ */}
      <div className="grid grid-cols-7 gap-2 mb-4">
        {dayNames.map((dayName) => (
          <div
            key={dayName}
            className="h-8 flex items-center justify-center text-sm font-semibold text-gray-600 bg-gray-50 rounded-lg"
          >
            {dayName}
          </div>
        ))}
      </div>

      {/* Ø´Ø¨ÙƒØ© Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø© */}
      <div className="grid grid-cols-7 gap-2">
        {daysData.map((dayData, index) => {
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          if (!dayData || !dayData.isCurrentMonth) {
            return (
              <div
                key={`empty-${index}`}
                className="h-12 flex items-center justify-center"
              >
                {dayData && (
                  <span className="text-xs text-gray-300">{dayData.day}</span>
                )}
              </div>
            )
          }

          const dateString = dayData.date
          const isToday = dayData.isToday
          const isBooked = isDayBooked(dateString)
          const isBlocked = isDayBlocked(dateString)
          const isPast = dayData.isPast

          // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
          let circleColor = ''
          if (isToday) {
            circleColor = 'bg-indigo-600 text-white' // Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
          } else if (isBooked) {
            circleColor = 'bg-orange-500 text-white' // Ø£ÙŠØ§Ù… Ù…Ø­Ø¬ÙˆØ²Ø© - Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
          } else if (isBlocked) {
            circleColor = 'bg-red-500 text-white' // Ø£ÙŠØ§Ù… Ù…Ù‚ÙÙ„Ø©
          } else {
            circleColor = isPast ? 'text-gray-400' : 'text-gray-700 active:bg-gray-100' // Ø£ÙŠØ§Ù… Ø¹Ø§Ø¯ÙŠØ©
          }

          return (
            <button
              key={dateString}
              onClick={() => handleDayClick(dayData)}
              className="h-12 flex items-center justify-center transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50"
              title={`${dayData.day} - ${isToday ? 'Ø§Ù„ÙŠÙˆÙ…' : isBooked ? 'Ù…Ø­Ø¬ÙˆØ²' : isBlocked ? 'Ù…Ù‚ÙÙ„' : 'Ù…ØªØ§Ø­'}`}
            >
              <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 ${circleColor}`}>
                {dayData.day}
              </div>
            </button>
          )
        })}
      </div>

      {/* Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹ */}
      <div className="mt-6 pt-4 border-t border-gray-100">
        <div className="flex items-center justify-center space-x-6 rtl:space-x-reverse text-sm">

          {/* Ù…Ø¤Ø´Ø± Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ */}
          <div className="flex items-center space-x-2 rtl:space-x-reverse">
            <div className="w-4 h-4 bg-indigo-600 rounded-full"></div>
            <span className="text-gray-600">Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
          </div>

          {/* Ù…Ø¤Ø´Ø± Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø© - Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */}
          <div className="flex items-center space-x-2 rtl:space-x-reverse">
            <div className="w-4 h-4 bg-orange-500 rounded-full"></div>
            <span className="text-gray-600">Ø£ÙŠØ§Ù… Ù…Ø­Ø¬ÙˆØ²Ø© ({bookings.length})</span>
          </div>

          {/* Ù…Ø¤Ø´Ø± Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ù‚ÙÙ„Ø© */}
          {blockedTimes.filter(b => b.startTime === null && b.endTime === null).length > 0 && (
            <div className="flex items-center space-x-2 rtl:space-x-reverse">
              <div className="w-4 h-4 bg-red-500 rounded-full"></div>
              <span className="text-gray-600">Ø£ÙŠØ§Ù… Ù…Ù‚ÙÙ„Ø© ({blockedTimes.filter(b => b.startTime === null && b.endTime === null).length})</span>
            </div>
          )}
        </div>

        {/* Ù†ØµÙŠØ­Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… */}
        <div className="mt-3 text-center">
          <p className="text-xs text-gray-500">
            ğŸ’¡ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ ÙŠÙˆÙ… Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù…ÙØµÙ„
          </p>
        </div>
      </div>
    </div>
  )
}