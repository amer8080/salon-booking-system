'use client'

import { useCallback } from 'react'
import { Booking, BlockedTime } from '../../types/booking.types'
import { formatIstanbulDate, getDaysInMonth } from '@/lib/timezone'

interface MonthViewProps {
  // بيانات التاريخ
  currentMonth: Date

  // بيانات الحجوزات
  bookings: Booking[]
  blockedTimes: BlockedTime[]

  // التفاعل
  onSwitchToDayView: (date: string) => void

  className?: string
}

export default function MonthView({
  currentMonth,
  bookings,
  blockedTimes,
  onSwitchToDayView,
  className = ""
}: MonthViewProps) {

  // حساب أيام الشهر
  const daysData = getDaysInMonth(currentMonth)
  const today = new Date()
  const todayString = formatIstanbulDate(today, 'date')

  // أسماء أيام الأسبوع مختصرة
  const dayNames = ['ح', 'ن', 'ث', 'ر', 'خ', 'ج', 'س']

  // فحص إذا كان اليوم مقفل
  const isDayBlocked = useCallback((dateString: string) => {
    return blockedTimes.some(blocked =>
      blocked.startTime === null && 
      blocked.endTime === null &&
      blocked.date === dateString
    )
  }, [blockedTimes])

  // الحصول على حجوزات اليوم
  const getBookingsForDate = useCallback((dateString: string) => {
    return bookings.filter(booking => {
      const bookingDate = formatIstanbulDate(new Date(booking.date), 'date')
      return bookingDate === dateString
    })
  }, [bookings])

  // فحص إذا كان اليوم محجوز
  const isDayBooked = useCallback((dateString: string) => {
    const dayBookings = getBookingsForDate(dateString)
    return dayBookings.length > 0
  }, [getBookingsForDate])

  // معالجة النقر على اليوم
  const handleDayClick = useCallback((dayData: {date: string, day: number, isCurrentMonth: boolean}) => {
    if (!dayData.isCurrentMonth) return

    // التحول للعرض اليومي
    onSwitchToDayView(dayData.date)
  }, [onSwitchToDayView])

  return (
    <div className={`bg-white rounded-xl shadow-lg p-6 ${className}`}>

      {/* أسماء أيام الأسبوع */}
      <div className="grid grid-cols-7 gap-2 mb-4">
        {dayNames.map((dayName) => (
          <div
            key={dayName}
            className="h-8 flex items-center justify-center text-sm font-semibold text-gray-600 bg-gray-50 rounded-lg"
          >
            {dayName}
          </div>
        ))}
      </div>

      {/* شبكة التقويم المضغوطة */}
      <div className="grid grid-cols-7 gap-2">
        {daysData.map((dayData, index) => {
          // التحقق من البيانات
          if (!dayData || !dayData.isCurrentMonth) {
            return (
              <div
                key={`empty-${index}`}
                className="h-12 flex items-center justify-center"
              >
                {dayData && (
                  <span className="text-xs text-gray-300">{dayData.day}</span>
                )}
              </div>
            )
          }

          const dateString = dayData.date
          const isToday = dayData.isToday
          const isBooked = isDayBooked(dateString)
          const isBlocked = isDayBlocked(dateString)
          const isPast = dayData.isPast

          // تحديد لون الدائرة
          let circleColor = ''
          if (isToday) {
            circleColor = 'bg-indigo-600 text-white' // اليوم الحالي
          } else if (isBooked) {
            circleColor = 'bg-orange-500 text-white' // أيام محجوزة - برتقالي
          } else if (isBlocked) {
            circleColor = 'bg-red-500 text-white' // أيام مقفلة
          } else {
            circleColor = isPast ? 'text-gray-400' : 'text-gray-700 active:bg-gray-100' // أيام عادية
          }

          return (
            <button
              key={dateString}
              onClick={() => handleDayClick(dayData)}
              className="h-12 flex items-center justify-center transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50"
              title={`${dayData.day} - ${isToday ? 'اليوم' : isBooked ? 'محجوز' : isBlocked ? 'مقفل' : 'متاح'}`}
            >
              <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 ${circleColor}`}>
                {dayData.day}
              </div>
            </button>
          )
        })}
      </div>

      {/* ملخص سريع */}
      <div className="mt-6 pt-4 border-t border-gray-100">
        <div className="flex items-center justify-center space-x-6 rtl:space-x-reverse text-sm">

          {/* مؤشر اليوم الحالي */}
          <div className="flex items-center space-x-2 rtl:space-x-reverse">
            <div className="w-4 h-4 bg-indigo-600 rounded-full"></div>
            <span className="text-gray-600">اليوم الحالي</span>
          </div>

          {/* مؤشر الأيام المحجوزة - برتقالي */}
          <div className="flex items-center space-x-2 rtl:space-x-reverse">
            <div className="w-4 h-4 bg-orange-500 rounded-full"></div>
            <span className="text-gray-600">أيام محجوزة ({bookings.length})</span>
          </div>

          {/* مؤشر الأيام المقفلة */}
          {blockedTimes.filter(b => b.startTime === null && b.endTime === null).length > 0 && (
            <div className="flex items-center space-x-2 rtl:space-x-reverse">
              <div className="w-4 h-4 bg-red-500 rounded-full"></div>
              <span className="text-gray-600">أيام مقفلة ({blockedTimes.filter(b => b.startTime === null && b.endTime === null).length})</span>
            </div>
          )}
        </div>

        {/* نصيحة للمستخدم */}
        <div className="mt-3 text-center">
          <p className="text-xs text-gray-500">
            💡 انقر على أي يوم للانتقال للعرض اليومي المفصل
          </p>
        </div>
      </div>
    </div>
  )
}