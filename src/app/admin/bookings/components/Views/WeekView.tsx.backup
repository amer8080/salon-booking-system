'use client'
import { useState, useMemo } from 'react'
import { Booking, Service } from '../../types/booking.types'
import BookingCard from '../Bookings/BookingCard'
import { fromDatabaseTime, formatIstanbulDate, formatArabicDate, addDaysIstanbul, getArabicDayName } from '@/lib/timezone'

interface WeekViewProps {
  // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  selectedDate: string
  bookings: Booking[]
  services: Record<string, Service>
  servicesWithCategories: Record<string, Service & { category: string }>
  adminTimeSlots: string[]
  blockedTimes: any[]

  // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ù„ÙˆØ§Ù†
  getServiceColor: (serviceId: string) => string

  // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„
  onCreateNewBooking: (date: string, time: string) => void
  onEditBooking: (booking: Booking) => void
  onDeleteBooking: (booking: Booking) => void
  onShowPhoneMenu?: (phone: string, customerName: string) => void

  // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…Ù‚ÙÙ„Ø©
  onBlockTime?: (date: string, time: string) => void
  onUnblockTime?: (date: string, time: string) => void

  // Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„ØªØ­ÙˆÙ„ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ…ÙŠ - ØªÙ… Ù†Ù‚Ù„Ù‡Ù… Ù„Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…ÙˆØ­Ø¯
  onDateChange: (newDate: string) => void
  onSwitchToDayView: (date: string) => void
}

export default function WeekView({
  selectedDate,
  bookings,
  services,
  servicesWithCategories,
  adminTimeSlots,
  blockedTimes,
  getServiceColor,
  onCreateNewBooking,
  onEditBooking,
  onDeleteBooking,
  onShowPhoneMenu,
  onBlockTime,
  onUnblockTime,
  onDateChange,
  onSwitchToDayView
}: WeekViewProps) {
  const [selectedTimeSlot, setSelectedTimeSlot] = useState<{date: string, time: string, booking?: Booking} | null>(null)

  // Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø®ØªØµØ±Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
  const getShortDayName = (date: Date) => {
    const dayNames = ['Ø£Ø­Ø¯', 'Ø§Ø«Ù†', 'Ø«Ù„Ø§', 'Ø£Ø±Ø¨', 'Ø®Ù…ÙŠ', 'Ø¬Ù…Ø¹', 'Ø³Ø¨Øª']
    return dayNames[date.getDay()]
  }

  // Ø­Ø³Ø§Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ - Ø¨Ø¯ÙˆÙ† reverse Ù‡Ù†Ø§
  const weekDays = useMemo(() => {
    const startDate = new Date(selectedDate)
    const dayOfWeek = startDate.getDay() // 0 = Ø§Ù„Ø£Ø­Ø¯
    const weekStart = new Date(startDate)
    weekStart.setDate(startDate.getDate() - dayOfWeek)

    const days = []
    for (let i = 0; i < 7; i++) {
      const day = new Date(weekStart)
      day.setDate(weekStart.getDate() + i)
      days.push({
        date: formatIstanbulDate(day, 'date'),
        dayName: getShortDayName(day),
        dayNumber: day.getDate(),
        fullDate: day,
        isToday: formatIstanbulDate(day, 'date') === formatIstanbulDate(new Date(), 'date')
      })
    }
    return days
  }, [selectedDate])

  // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
  const weekBookings = useMemo(() => {
    const bookingsByDateTime: Record<string, Booking> = {}

    bookings.forEach(booking => {
      try {
        const bookingDate = formatIstanbulDate(fromDatabaseTime(booking.date), 'date')
        const bookingTime = formatIstanbulDate(fromDatabaseTime(booking.startTime), 'time')
        const key = `${bookingDate}-${bookingTime}`
        bookingsByDateTime[key] = booking
      } catch (error) {
        console.warn('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²:', booking, error)
      }
    })

    return bookingsByDateTime
  }, [bookings])

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…Ù‚ÙÙ„Ø©
  const isTimeBlocked = (date: string, time: string) => {
    return blockedTimes.some(blocked =>
      blocked.date === date && blocked.startTime === time
    )
  }

  // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„Ø§ÙŠØ§
  const handleCellClick = (date: string, time: string, booking?: Booking) => {
    setSelectedTimeSlot({ date, time, booking })
  }

  // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø±Ø£Ø³ Ø§Ù„ÙŠÙˆÙ… Ù„Ù„ØªØ­ÙˆÙ„ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ…ÙŠ
  const handleDayHeaderClick = (date: string) => {
    onSwitchToDayView(date)
  }

  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙƒØ±Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚
  const closeBookingCard = () => {
    setSelectedTimeSlot(null)
  }

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙƒØ±Øª
  const handleCardCreateNew = (date: string, time: string) => {
    onCreateNewBooking(date, time)
    closeBookingCard()
  }

  const handleCardEdit = (booking: Booking) => {
    onEditBooking(booking)
    closeBookingCard()
  }

  const handleCardDelete = (booking: Booking) => {
    onDeleteBooking(booking)
    closeBookingCard()
  }

  const handleCardBlockTime = (date: string, time: string) => {
    if (onBlockTime) {
      onBlockTime(date, time)
      closeBookingCard()
    }
  }

  const handleCardUnblockTime = (date: string, time: string) => {
    if (onUnblockTime) {
      onUnblockTime(date, time)
      closeBookingCard()
    }
  }

  return (
    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
      {/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø­Ø³Ù† Ù„Ù„Ø¬ÙˆØ§Ù„ Ù…Ø¹ RTL - Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */}
      <div className="overflow-x-auto" dir="rtl">
        <table className="w-full text-xs min-w-full mobile-table-compact lg:text-sm" style={{ tableLayout: 'fixed' }}>
          {/* Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ - Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù…Ø¹ RTL Ù…Ø­Ø³Ù† */}
          <thead>
            <tr className="bg-gray-50 border-b">
              {/* Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙˆÙ‚Øª - Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¨Ø³Ø¨Ø¨ RTL */}
              <th className="w-16 lg:w-20 p-1 text-center text-xs font-medium text-gray-600 border-l bg-gray-100">
                ÙˆÙ‚Øª
              </th>
              
              {/* Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£ÙŠØ§Ù… - Ù…ÙˆØ²Ø¹Ø© Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ Ù…Ø¹ RTL Ø·Ø¨ÙŠØ¹ÙŠ */}
              {weekDays.map((day) => (
                <th
                  key={day.date}
                  className="p-1 text-center border-l cursor-pointer booking-active-today transition-colors"
                  style={{ width: `calc((100% - 80px) / 7)` }}
                  onClick={() => handleDayHeaderClick(day.date)}
                  title={`Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ­ÙˆÙ„ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ…ÙŠ`}
                >
                  <div className="space-y-0.5">
                    <div className={`text-xs font-bold ${
                      day.isToday ? 'booking-color-today booking-text-today rounded-full px-1 py-0.5' : 'text-gray-700'
                    }`}>
                      {day.dayName}
                    </div>
                    <div className={`text-sm font-bold ${
                      day.isToday
                        ? 'booking-color-today booking-text-today rounded-full w-5 h-5 flex items-center justify-center mx-auto text-xs'
                        : 'text-gray-800'
                    }`}>
                      {day.dayNumber}
                    </div>
                  </div>
                </th>
              ))}
            </tr>
          </thead>

          {/* Ø¬Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ - Ø§Ù„Ø£ÙˆÙ‚Ø§Øª ÙˆØ§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */}
          <tbody>
            {adminTimeSlots.map((time, timeIndex) => (
              <tr key={time} className={timeIndex % 2 === 0 ? 'bg-white' : 'bg-gray-25'}>
                {/* Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙˆÙ‚Øª - Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¨Ø³Ø¨Ø¨ RTL */}
                <td className="w-16 lg:w-20 p-1 text-center border-l border-b bg-gray-50">
                  <span className="font-mono text-xs text-gray-600">
                    {time}
                  </span>
                </td>

                {/* Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ø£ÙŠØ§Ù… Ù…Ø¹ RTL ÙˆØ§Ø±ØªÙØ§Ø¹ Ù…Ø­Ø³Ù† */}
                {weekDays.map((day) => {
                  const booking = weekBookings[`${day.date}-${time}`]
                  const blocked = isTimeBlocked(day.date, time)

                  // ØªØ­Ø¯ÙŠØ¯ ÙØ¦Ø§Øª CSS Ù„Ù„Ø®Ù„ÙŠØ© Ù…Ø¹ Ø§Ø±ØªÙØ§Ø¹ Ù…Ø­Ø³Ù†
                  let cellClass = 'p-0.5 border-l border-b cursor-pointer transition-colors smooth-transition'
                  
                  // Ø§Ø±ØªÙØ§Ø¹ Ù…Ø­Ø³Ù† Ù„Ù„Ø¬ÙˆØ§Ù„ ÙˆØ§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨
                  cellClass += ' h-6 lg:h-8'

                  if (booking) {
                    cellClass += ' booking-color-booked booking-active-booked' // Ù…Ø­Ø¬ÙˆØ² - Ø£Ù„ÙˆØ§Ù† Ù…Ø®ØµØµØ©
                  } else if (blocked) {
                    cellClass += ' booking-color-blocked booking-active-blocked' // Ù…Ù‚ÙÙ„ - Ø£Ù„ÙˆØ§Ù† Ù…Ø®ØµØµØ©
                  } else {
                    cellClass += ' booking-color-available booking-active-available' // Ù…ØªØ§Ø­ - Ø£Ù„ÙˆØ§Ù† Ù…Ø®ØµØµØ©
                  }

                  return (
                    <td
                      key={`${day.date}-${time}`}
                      className={cellClass}
                      onClick={() => handleCellClick(day.date, time, booking)}
                      title={booking ? `${booking.customerName} - ${time}` : blocked ? `ÙˆÙ‚Øª Ù…Ù‚ÙÙ„ - ${time}` : `ÙˆÙ‚Øª Ù…ØªØ§Ø­ - ${time}`}
                    >
                      <div className="flex items-center justify-center h-full">
                        {booking && (
                          /* Ø¹Ø±Ø¶ Ø§Ø®ØªØµØ§Ø± Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø¶ØºÙˆØ· */
                          <span className="booking-text-booked text-xs font-semibold truncate px-0.5 max-w-full">
                            {booking.customerName.split(' ')[0].substring(0, 4)}
                          </span>
                        )}
                        {blocked && !booking && (
                          /* Ø±Ù…Ø² Ø§Ù„Ù‚ÙÙ„ Ù…ØµØºØ± */
                          <span className="booking-text-blocked text-xs">ğŸ”’</span>
                        )}
                      </div>
                    </td>
                  )
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* ØªØ°ÙŠÙŠÙ„ Ù…Ø¹ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø®ØµØµØ© - Ù…Ø­Ø³Ù† Ù„Ù„Ø¬ÙˆØ§Ù„ */}
      <div className="bg-gray-50 px-2 lg:px-4 py-1 lg:py-2 border-t">
        <div className="flex items-center justify-between text-xs text-gray-600">
          <div className="flex items-center space-x-2 lg:space-x-3 rtl:space-x-reverse">
            <div className="flex items-center space-x-1 rtl:space-x-reverse">
              <div className="w-2 h-2 lg:w-3 lg:h-3 booking-color-booked rounded"></div>
              <span>Ù…Ø­Ø¬ÙˆØ²</span>
            </div>
            <div className="flex items-center space-x-1 rtl:space-x-reverse">
              <div className="w-2 h-2 lg:w-3 lg:h-3 booking-color-available booking-border-available border rounded"></div>
              <span>ÙØ§Ø±Øº</span>
            </div>
            <div className="flex items-center space-x-1 rtl:space-x-reverse">
              <div className="w-2 h-2 lg:w-3 lg:h-3 booking-color-blocked rounded"></div>
              <span>Ù…ÙÙ‚ÙÙ„</span>
            </div>
          </div>
          <div className="text-gray-500 hidden lg:block">
            ğŸ’¡ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„ÙŠÙˆÙ… Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ…ÙŠ
          </div>
        </div>
      </div>

      {/* ÙƒØ±Øª Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ */}
      {selectedTimeSlot && (
        <BookingCard
          booking={selectedTimeSlot.booking}
          date={selectedTimeSlot.date}
          time={selectedTimeSlot.time}
          services={services}
          servicesWithCategories={servicesWithCategories}
          getServiceColor={getServiceColor}
          onEdit={handleCardEdit}
          onDelete={handleCardDelete}
          onCreateNew={handleCardCreateNew}
          onShowPhoneMenu={onShowPhoneMenu}
          isTimeBlocked={isTimeBlocked(selectedTimeSlot.date, selectedTimeSlot.time)}
          onBlockTime={handleCardBlockTime}
          onUnblockTime={handleCardUnblockTime}
          isOpen={true}
          onClose={closeBookingCard}
          position="center"
        />
      )}
    </div>
  )
}